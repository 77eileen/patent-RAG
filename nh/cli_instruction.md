# FTO 분석 시스템 구축 지시서 (Claude CLI용)

## 1. 프로젝트 목표

RAG 검색으로 히트된 특허 리스트(최대 10건)를 받아서, 3단계 파이프라인으로 FTO(Freedom to Operate) 침해 분석을 수행하고, 최종 결과를 HTML 보고서로 생성하는 시스템을 만들어줘.

- LLM: **Gemini-2.0-flash** (google-genai SDK)
- 언어: Python
- 출력: HTML 보고서 파일

---

## 2. 입력 데이터 구조

### 2-1. 사용자 질문
```python
user_query = "글리세린, 히알루론산, 우뭇가사리로 마스크 팩을 만들려고 해. 침해될까?"
```

### 2-2. 사용자 구성요소 (RAG 단계에서 이미 추출됨)
```python
user_components = "글리세린, 히알루론산, 우뭇가사리, 마스크팩, 마스크, 팩, 보습"
```

### 2-3. 특허 리스트 (RAG 검색 결과)
```python
patents_data = [
    {
        "rank": 1,
        "title": "특허명",
        "application_number": "출원번호",
        "register_number": "등록번호",
        "register_status": "등록/공개/소멸 등",
        "application_date": "2022-01-01",
        "register_date": "2023-06-15",
        "abstract": "요약",
        "ipc_codes": ["A61K 8/02"],
        "hit_count": 5,
        "best_similarity_score": 0.85,
        "avg_similarity_score": 0.72,
        "hit_queries": [("검색어", 0.85), ...],
        "all_claims": [
            "청구항 1\n털여뀌 추출물 및 살시드버터를...",
            "청구항 2\n제1항에 있어서,...",
            ...
        ],
        "claim_count": 5
    },
    ...  # 최대 10건
]
```

**중요:** `all_claims`는 리스트이며, 각 항목은 "청구항 N\n내용" 형태의 문자열임.

---

## 3. 파이프라인 구조 (3단계 분리)

### Step A: 특허 청구항에서 구성요소 추출
- 입력: 특허의 등록 청구항 중 독립항(청구항 1)
- 출력: 구성요소 리스트 (JSON 배열)
- 담당: Gemini-2.0-flash

### Step B: 구성 대비
- 입력: Step A의 구성요소 리스트 + 사용자 질문 + 사용자 구성요소
- 출력: 구성대비표 (JSON)
- 담당: Gemini-2.0-flash

### Step C: 판단 및 결론
- 입력: Step B의 구성대비표
- 출력: 판단 텍스트 + 결론 문구
- 담당: Gemini-2.0-flash

### 최종: HTML 보고서 생성
- 입력: 모든 특허의 Step A~C 결과
- 출력: HTML 파일

---

## 4. 각 Step별 시스템 프롬프트

### 4-1. Step A 프롬프트: 구성요소 추출

```
당신은 화장품 분야의 특허 청구항 분석 전문가입니다.
주어진 등록 청구항의 독립항(청구항 1)에서 구성요소를 추출하세요.

## 추출 규칙
1. 성분, 함량/비율, 제조방법 단계, 용도/효과/기능적 특성을 각각 별도 구성요소로 분리
2. "포함하는", "~로 이루어진" 등 연결 표현은 구성요소에서 제외
3. 함량/비율이 기재되어 있으면 해당 성분과 함께 하나의 구성요소로 추출
   예: "글리세린 5~20중량%" → "글리세린 5~20중량%"
4. 용도/효과도 구성요소로 추출
   예: "주름개선용 화장료 조성물" → "주름개선용" + "화장료 조성물"
5. 종속항은 무시하고 독립항(청구항 1)만 분석

## 출력 형식 (반드시 JSON 배열만 출력)
["구성요소1", "구성요소2", "구성요소3", ...]
```

### 4-2. Step B 프롬프트: 구성 대비

```
당신은 화장품 분야의 특허 침해(FTO) 분석 전문가입니다.

## 역할
특허에서 추출된 구성요소 리스트와 사용자 제품 구성을 1:1로 대비합니다.

## 대비 규칙

### 대응 여부 판정 기준
- **대응**: 사용자 제품에 해당 구성요소와 동일하거나 포함되는 구성이 있는 경우
- **미대응**: 사용자 제품에 해당 구성요소에 대응하는 것이 전혀 없는 경우 (사용자 제품 구성은 "미포함"으로 기재)
- **미대응(균등)**: 사용자 제품에 대응 구성이 있으나 수치 범위를 경미하게 벗어나거나 균등론 판단이 필요한 경우
- **미대응(내재성)**: 용도/효과/기능적 특성이 사용자 질문에 명시적으로 언급되지 않은 경우 (성분/제조방법이 동일하더라도 효과/기능이 사용자 질문에 없으면 반드시 "미대응(내재성)")
- **확인불가**: 사용자 제품에 해당 구성요소의 존재 여부를 확인할 수 없는 경우 (예: 함량 정보 미기재)

### 수치 범위 해석
- "A 내지 B", "A~B" 표현은 양 끝값을 포함하는 연속 범위
- 범위 내 모든 값은 구성요소 충족
- 범위 내부 값을 범위 밖으로 판단하는 오류 절대 금지

### 성분 나열 해석
- "A, B, C 중에서 선택되는": 하나 이상 포함하면 대응
- "A, B 또는 C를 포함하는": 하나 이상 포함하면 대응
- "A, B 및 C를 포함하는": 모두 포함해야 대응
- "적어도 하나의 A, B 및 C": 하나 이상 포함하면 대응
- "포함하는(comprising)": 개방형 - 추가 성분 있어도 충족에 영향 없음

### 용도 포괄 규칙
- "화장료 조성물", "피부 국소표면 도포 조성물" 등은 크림, 로션, 에센스, 샴푸, 토너, 선크림 등 포괄
- 사용자 제품 용도가 특허 용도의 상위/하위 카테고리이면 "대응"
- 용도/효과가 사용자 질문에 반대 특성으로 명시된 경우 → "미대응" (내재성 아님)
  예: 특허 "비수계" vs 사용자 "수계" → 미대응

## 출력 형식 (반드시 JSON만 출력)
{
  "comparison": [
    {
      "patent_component": "특허 구성요소",
      "user_component": "사용자 제품 대응 구성 또는 미포함 또는 확인불가",
      "match_status": "대응|미대응|미대응(균등)|미대응(내재성)|확인불가"
    },
    ...
  ]
}
```

### 4-3. Step C 프롬프트: 판단 및 결론

```
당신은 화장품 분야의 특허 침해(FTO) 분석 전문가입니다. 사용자가 이해하기 쉽게 설명해주세요.

## ★ 문구 규칙 (법적 리스크 방지 - 최우선!) ★
- "판단됩니다", "판단합니다" 등 "판단"이라는 단어를 절대 사용하지 마세요. "분석됩니다", "분석합니다"로 대체.
- "리스크"라는 단어도 사용하지 마세요. "가능성"으로 대체.

## FTO 판단 법리

### 1. 구성요소 완비의 원칙 (All Elements Rule)
- 모든 구성요소를 전부 포함해야 침해 인정
- 구성요소 중 하나라도 빠지면 침해 불성립
- 단, 균등론 또는 내재성 판단이 필요한 경우에는 문언침해가 되지 않더라도 전문가 검토 대상

### 2. 균등론 (Doctrine of Equivalents)
- 문언상 다르더라도 실질적으로 등가 관계이면 침해 인정 가능
- 수치 범위에서 경미하게 벗어남 → 전문가 검토 필요
- 수치 범위에서 현저하게 벗어남 → 비침해 (예: 청구항 10~30%에서 사용자 1%, 70%)

### 3. 금반언의 원칙 (Prosecution History Estoppel)
- 공개청구항에 있었으나 등록청구항에서 의도적으로 삭제된 구성요소 → 균등론 확장 주장 불가
- 등록청구항에서 삭제된 성분을 사용한 제품 → 비침해

### 4. 내재성 (Inherency)
- 동일 원료 + 동일 추출/제조법일 때, 특정 효과가 자연 발생적으로 충족되는지 판단 필요
- 성분이 모두 대응되고 용도/효과만 미대응인 경우 → "동일 성분을 포함하므로 해당 효과가 내재적으로 발생할 가능성이 높은 것으로 분석되며, 전문가 검토 필요"

## 구성대비 결과에 따른 결론 도출 규칙

### 결론 판정 로직
1. 모든 구성요소가 "대응" → "침해 가능성이 높은 것으로 분석됩니다."
2. "미대응"이 존재 (특허 핵심 구성 미충족) → "침해 가능성이 낮은 것으로 분석됩니다."
3. "확인불가"가 하나라도 존재 → "침해 여부 분석을 위해 보다 구체적인 실시 정보가 필요합니다."
4. 모든 구성요소 대응 + "미대응(균등)" 또는 "미대응(내재성)"만 존재 → "전문가의 추가 검토가 권고됩니다."

### 우선순위
- "확인불가" 존재 시: 다른 상태와 관계없이 → 정보부족 결론
  - 예외: "미대응"도 함께 존재하면 → 비침해 결론 가능
- "미대응" 존재 시: 다른 상태와 관계없이 → 비침해 결론
- 성분 모두 대응 + 용도만 다름(미대응(내재성)) → 전문가 검토 결론 (정보부족 아님)

### 제조방법 특허 특별 규칙
- 제조방법 특허는 성분뿐 아니라 제조방법도 구성요소
- 사용자가 성분만 질문하고 제조방법 미언급 → 제조방법은 "확인불가" → 정보부족 결론
- 성분 모두 동일 + 제조방법 확인 안 됨 → 정보부족 결론
- 성분 모두 동일 + 제조방법도 동일 → 침해 가능성 높음 결론

### 용도/효과 차이만으로 비침해 판단 금지
- 객관적 구성요소(원료, 조성물, 함량, 제조방법)를 우선 판단
- 성분이 모두 대응되면 용도/효과 미대응은 내재성 판단 대상 → 전문가 검토

## ★ 판단(◆판단◆) 작성 규칙 ★

### 판단의 역할: 구성대비 결과에 대한 "분석"만 작성. 침해 여부 "결론"은 ◆결론◆에서만!

### 결론별 올바른 판단 마무리 패턴
- 침해 가능성 높음 → 첫 문장: "사용자 제품은 특허의 모든 구성요소를 포함하고 있습니다." + 핵심 포인트 추가 설명
- 전문가 검토 → "균등론/내재성 판단이 필요한 구성요소가 있습니다." + 어떤 부분이 필요한지 상세 설명
- 비침해 → "특허의 구성요소 중 일부만 포함하고 있어 사용자의 제품과 차이가 있습니다" + 간단 추가설명
- 정보부족 → "구체적인 실시 정보가 추가로 필요합니다." + 확인불가 항목 설명

### 판단에서 절대 금지하는 문구
- "침해에 해당하지 않습니다"
- "침해가 성립합니다"
- "침해 가능성이 존재할 수 있습니다"
- "침해 가능성은 낮습니다"
- "침해 가능성이 높습니다"
(이런 결론성 문구는 ◆결론◆에서만 사용)

## 출력 형식 (JSON)
{
  "judgment": "판단 텍스트 (2~5문장)",
  "conclusion": "침해 가능성이 높은 것으로 분석됩니다.|침해 가능성이 낮은 것으로 분석됩니다.|침해 여부 분석을 위해 보다 구체적인 실시 정보가 필요합니다.|전문가의 추가 검토가 권고됩니다."
}
```

---

## 5. HTML 보고서 출력 형식

아래 구조의 HTML 파일을 생성해줘. 스타일은 깔끔한 전문 보고서 느낌으로.

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>FTO REPORT</title>
    <style>
        /* 전문적인 보고서 스타일 */
        /* 테이블, 헤더, 결론별 색상 배지 등 */
    </style>
</head>
<body>

<!-- 1. 헤더 -->
<h1>FTO REPORT</h1>
<p>분석일: {날짜}</p>

<!-- 2. 사용자 질문 -->
<h2>사용자 질문</h2>
<div class="query-box">{user_query}</div>

<!-- 3. 요약 테이블 -->
<h2>주요 특허 리스트</h2>
<table>
  <tr>
    <th>순위</th>
    <th>특허 출원번호</th>
    <th>등록번호</th>
    <th>현재 상태</th>
    <th>발명의 명칭</th>
    <th>분석 결론</th>
  </tr>
  <!-- 각 특허별 한 줄 요약 -->
  <tr>
    <td>1</td>
    <td>{application_number}</td>
    <td>{register_number}</td>
    <td>{register_status}</td>
    <td>{title}</td>
    <td><span class="badge-danger">침해 가능성 높음</span></td>
  </tr>
  ...
</table>

<!-- 4. 상세 분석 (각 특허별) -->
<h2>특허에 대한 상세 분석</h2>

<!-- 특허 1 -->
<div class="patent-section">
  <h3>[1] 특허 출원번호: {application_number} / 등록번호: {register_number}</h3>
  <p>특허번호 {register_number}의 독립항의 모든 구성요소와 사용자가 실시하고자 하는 제품의 구성을 비교한 결과는 다음과 같습니다.</p>

  <h4>◆구성 대비◆</h4>
  <table>
    <tr><th>특허 구성</th><th>사용자 제품 구성</th><th>대응 여부</th></tr>
    <!-- Step B 결과를 여기에 렌더링 -->
  </table>

  <h4>◆판단◆</h4>
  <p>{Step C의 judgment}</p>

  <h4>◆결론◆</h4>
  <p class="conclusion">{Step C의 conclusion}</p>
</div>

<!-- 특허 2~N 반복 -->

</body>
</html>
```

### 결론별 배지 색상
- "침해 가능성이 높은 것으로 분석됩니다." → 빨간색 (badge-danger)
- "침해 가능성이 낮은 것으로 분석됩니다." → 초록색 (badge-safe)
- "전문가의 추가 검토가 권고됩니다." → 주황색 (badge-warning)
- "침해 여부 분석을 위해 보다 구체적인 실시 정보가 필요합니다." → 회색 (badge-info)

---

## 6. 코드 구조

```
fto_analyzer/
├── main.py              # 메인 실행 (특허 리스트 받아서 파이프라인 실행)
├── fto_pipeline.py      # 3단계 파이프라인 (Step A → B → C)
├── prompts.py           # 각 Step별 시스템 프롬프트 상수
├── report_generator.py  # HTML 보고서 생성
└── config.py            # Gemini API 설정
```

### main.py 역할
```python
def run_fto_analysis(user_query: str, user_components: str, patents_data: list) -> str:
    """
    FTO 분석 전체 파이프라인 실행
    
    Args:
        user_query: 사용자 질문
        user_components: RAG에서 추출한 사용자 구성요소
        patents_data: RAG 검색 결과 특허 리스트
    
    Returns:
        str: 생성된 HTML 보고서 파일 경로
    """
```

### fto_pipeline.py 역할
```python
def step_a_extract_components(claim_text: str) -> list:
    """청구항에서 구성요소 추출 → JSON 리스트 반환"""

def step_b_compare(patent_components: list, user_query: str, user_components: str) -> dict:
    """구성 대비 수행 → JSON 반환"""

def step_c_judge(comparison_result: dict) -> dict:
    """판단 및 결론 도출 → JSON 반환"""

def analyze_single_patent(patent: dict, user_query: str, user_components: str) -> dict:
    """단일 특허에 대해 Step A→B→C 순차 실행"""
```

---

## 7. Gemini API 호출 형식

```python
import google.generativeai as genai

genai.configure(api_key=os.environ["GOOGLE_API_KEY"])
model = genai.GenerativeModel("gemini-2.0-flash")

response = model.generate_content(
    contents=[
        {"role": "user", "parts": [{"text": prompt}]}
    ],
    generation_config=genai.GenerationConfig(
        temperature=0,
        response_mime_type="application/json"  # JSON 응답 강제
    )
)

result = json.loads(response.text)
```

**중요:** `response_mime_type="application/json"`을 사용하여 JSON 출력을 강제할 것.

---

## 8. 주의사항

1. **독립항만 분석**: all_claims 리스트에서 "청구항 1"만 추출하여 분석. 종속항(청구항 2, 3...)은 무시.
   - 단, "청구항 1"이 "(삭제)"인 경우 다음 독립항을 찾아야 함.

2. **에러 핸들링**: 특허별로 분석이 실패해도 나머지 특허는 계속 분석. 실패한 건은 보고서에 "분석 실패"로 표시.

3. **등록번호 vs 공개번호**: register_number가 있으면 등록번호 사용, 없으면 application_number 사용.

4. **학습용 라벨 관련 코드 없음**: 라벨 분류, 목표 라벨 등 학습 데이터 관련 로직은 일절 넣지 말 것.

5. **HTML 보고서는 단일 파일**: CSS, JS 모두 인라인으로 HTML 안에 포함.

---

## 9. 개별 분석 결과 분리 저장

특허 10건을 한꺼번에 LLM에 넘기면 출력 품질이 떨어지므로,
각 특허별로 개별 분석 후 마지막에 HTML을 조립하는 구조로 구현.

1. 각 특허별로 Step A→B→C를 **개별 실행** (LLM은 1건씩만 처리)
2. 각 결과를 `analysis_results` 리스트에 append
3. 모든 특허 분석 완료 후, `report_generator.py`에서 HTML **한번에 조립**

### analysis_results 구조

```python
analysis_results = [
    {
        # 등록 특허 (LLM 분석 대상)
        "rank": 1,
        "application_number": "...",
        "register_number": "...",
        "open_number": "...",
        "register_status": "등록",
        "title": "...",
        "is_registered": True,
        "success": True,
        "error": None,
        "claim_text": "...",
        "components": [...],     # Step A 결과
        "comparison": {...},     # Step B 결과
        "judgment": "...",       # Step C 결과
        "conclusion": "..."      # Step C 결과
    },
    {
        # 미등록 특허 (LLM 스킵)
        "rank": 2,
        "is_registered": False,
        "application_number": "...",
        "pub_number": "...",
        "open_number": "...",
        "register_status": "공개",
        "title": "...",
        "claims_text": "...",
        "template_message": "...",  # 고정 문구
        "success": True,
        "error": None
    },
]
```

---

## 10. 공개 문헌(미등록) 별도 처리

### 판정 기준
- `register_number`가 없거나 빈 문자열 → **미등록**
- `register_status`가 `"등록"`이 아닌 경우 → **미등록**
  (예: "공개", "출원", "거절", "취하" 등)

### 미등록 특허 처리 규칙
- **LLM에 보내지 않음** (Step A, B, C 모두 스킵)
- 요약 테이블에는 표시하되, 결론 컬럼에 `"공개 문헌 (모니터링 권장)"` 표시
- 상세 분석 섹션에서는 아래 고정 템플릿 사용

### 고정 템플릿

```
[{순위}] 특허 출원번호: {application_number} / 공개번호: {pub_number}
현재 청구항: {all_claims의 마지막 버전 텍스트}

검색 결과, 사용자의 제품 구성과 유사한 내용을 포함하는 공개특허가
확인되었습니다. 해당 문헌은 현재 출원 공개 단계로, 아직 권리가
확정된 상태는 아닙니다. 다만 향후 심사 과정에서 등록될 경우
권리가 발생할 수 있으므로, 심사 진행 및 등록 여부를 지속적으로
모니터링하시길 권장드립니다.
```

### HTML 스타일
- `notice-box`: 파란색 테두리(#42a5f5) + 연한 파란색 배경(#e3f2fd)
- `badge-monitor`: 파란색 배지

### 분석 대상 예시
- TOP 10 중 등록 7건 + 공개 3건 → LLM은 7건만 분석, 공개 3건은 템플릿
